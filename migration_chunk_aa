-- ============================================================================
-- Combined Migrations from cymasphere-website
-- Total migrations: 57
-- Generated: 2025-12-14T23:18:10.903Z
-- ============================================================================

-- Disable foreign key checks temporarily
SET session_replication_role = 'replica';


-- ============================================================================
-- Migration: 20240320000000_create_customers_table.sql
-- ============================================================================

create table if not exists public.customers (
  id uuid default gen_random_uuid() primary key,
  stripe_customer_id text not null unique,
  email text not null,
  created_at timestamp with time zone default timezone('utc'::text, now()) not null,
  updated_at timestamp with time zone default timezone('utc'::text, now()) not null
);

-- Enable RLS
alter table public.customers enable row level security;

-- Create policies
create policy "Customers are viewable by authenticated users" on public.customers
  for select using (auth.role() = 'authenticated');

create policy "Customers are insertable by service role" on public.customers
  for insert with check (auth.role() = 'service_role');

create policy "Customers are updatable by service role" on public.customers
  for update using (auth.role() = 'service_role');

-- Create updated_at trigger using a simple function
create or replace function update_updated_at_column()
returns trigger as $$
begin
    new.updated_at = now();
    return new;
end;
$$ language plpgsql;

create trigger handle_updated_at before update on public.customers
  for each row execute procedure update_updated_at_column(); 


-- ============================================================================
-- Migration: 20241201000000_add_admin_subscription_type.sql
-- ============================================================================

-- Create subscription_type enum if it doesn't exist
DO $$ BEGIN
    CREATE TYPE public.subscription_type AS ENUM ('none', 'monthly', 'annual', 'lifetime');
EXCEPTION
    WHEN duplicate_object THEN null;
END $$;

-- Add 'admin' to the subscription_type enum
-- This allows users to have admin privileges in the application

-- First, let's add the new enum value
ALTER TYPE public.subscription_type ADD VALUE IF NOT EXISTS 'admin';
 
-- The enum should now support: 'none', 'monthly', 'annual', 'lifetime', 'admin'
-- No need to modify the profiles table as it already uses this enum type 


-- ============================================================================
-- Migration: 20241220000000_create_support_tickets_system.sql
-- ============================================================================

-- Create support ticket system tables
-- This migration creates the complete support ticket infrastructure

-- Create enums for ticket status and priority
CREATE TYPE public.ticket_status AS ENUM (
  'open',
  'in_progress', 
  'resolved',
  'closed'
);

CREATE TYPE public.ticket_priority AS ENUM (
  'low',
  'medium',
  'high',
  'urgent'
);

CREATE TYPE public.message_type AS ENUM (
  'text',
  'system'
);

CREATE TYPE public.attachment_type AS ENUM (
  'image',
  'video',
  'document',
  'audio',
  'other'
);

-- Create support_tickets table
CREATE TABLE IF NOT EXISTS public.support_tickets (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  ticket_number text NOT NULL UNIQUE, -- Human readable ticket ID like "T-001"
  subject text NOT NULL,
  description text,
  status public.ticket_status DEFAULT 'open' NOT NULL,
  priority public.ticket_priority DEFAULT 'medium' NOT NULL,
  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  assigned_to uuid REFERENCES auth.users(id) ON DELETE SET NULL, -- Admin user assigned to ticket
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL,
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL,
  resolved_at timestamp with time zone,
  closed_at timestamp with time zone
);

-- Create support_messages table
CREATE TABLE IF NOT EXISTS public.support_messages (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  ticket_id uuid NOT NULL REFERENCES public.support_tickets(id) ON DELETE CASCADE,
  user_id uuid NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  content text NOT NULL,
  message_type public.message_type DEFAULT 'text' NOT NULL,
  is_admin boolean DEFAULT false NOT NULL, -- True if message is from admin/support
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL,
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL,
  edited_at timestamp with time zone
);

-- Create support_attachments table
CREATE TABLE IF NOT EXISTS public.support_attachments (
  id uuid DEFAULT gen_random_uuid() PRIMARY KEY,
  message_id uuid NOT NULL REFERENCES public.support_messages(id) ON DELETE CASCADE,
  file_name text NOT NULL,
  file_size bigint NOT NULL, -- Size in bytes
  file_type text NOT NULL, -- MIME type
  attachment_type public.attachment_type NOT NULL,
  storage_path text NOT NULL, -- Path in Supabase storage
  url text, -- Public URL if applicable
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()) NOT NULL
);

-- Create indexes for better performance
CREATE INDEX idx_support_tickets_user_id ON public.support_tickets(user_id);
CREATE INDEX idx_support_tickets_assigned_to ON public.support_tickets(assigned_to);
CREATE INDEX idx_support_tickets_status ON public.support_tickets(status);
CREATE INDEX idx_support_tickets_priority ON public.support_tickets(priority);
CREATE INDEX idx_support_tickets_created_at ON public.support_tickets(created_at);
CREATE INDEX idx_support_tickets_ticket_number ON public.support_tickets(ticket_number);

CREATE INDEX idx_support_messages_ticket_id ON public.support_messages(ticket_id);
CREATE INDEX idx_support_messages_user_id ON public.support_messages(user_id);
CREATE INDEX idx_support_messages_created_at ON public.support_messages(created_at);

CREATE INDEX idx_support_attachments_message_id ON public.support_attachments(message_id);

-- Enable RLS on all tables
ALTER TABLE public.support_tickets ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.support_messages ENABLE ROW LEVEL SECURITY;
ALTER TABLE public.support_attachments ENABLE ROW LEVEL SECURITY;

-- Create RLS policies for support_tickets
-- Users can view their own tickets
CREATE POLICY "Users can view their own tickets" ON public.support_tickets
  FOR SELECT USING (
    auth.uid() = user_id OR 
    EXISTS (
      SELECT 1 FROM public.profiles 
      WHERE id = auth.uid() AND subscription = 'admin'
    )
  );

-- Users can create their own tickets
CREATE POLICY "Users can create their own tickets" ON public.support_tickets
  FOR INSERT WITH CHECK (auth.uid() = user_id);

-- Users can update their own tickets (limited fields)
CREATE POLICY "Users can update their own tickets" ON public.support_tickets
  FOR UPDATE USING (auth.uid() = user_id)
  WITH CHECK (auth.uid() = user_id);

-- Admins can update any ticket
CREATE POLICY "Admins can update any ticket" ON public.support_tickets
  FOR UPDATE USING (
    EXISTS (
      SELECT 1 FROM public.profiles 
      WHERE id = auth.uid() AND subscription = 'admin'
    )
  );

-- Admins can delete tickets
CREATE POLICY "Admins can delete tickets" ON public.support_tickets
  FOR DELETE USING (
    EXISTS (
      SELECT 1 FROM public.profiles 
      WHERE id = auth.uid() AND subscription = 'admin'
    )
  );

-- Create RLS policies for support_messages
-- Users can view messages for their own tickets or if they're admin
CREATE POLICY "Users can view messages for their tickets" ON public.support_messages
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM public.support_tickets 
      WHERE id = ticket_id AND (
        user_id = auth.uid() OR 
        EXISTS (
          SELECT 1 FROM public.profiles 
          WHERE id = auth.uid() AND subscription = 'admin'
        )
      )
    )
  );

-- Users can create messages for their own tickets or if they're admin
CREATE POLICY "Users can create messages for their tickets" ON public.support_messages
  FOR INSERT WITH CHECK (
    auth.uid() = user_id AND (
      EXISTS (
        SELECT 1 FROM public.support_tickets 
        WHERE id = ticket_id AND user_id = auth.uid()
      ) OR
      EXISTS (
        SELECT 1 FROM public.profiles 
        WHERE id = auth.uid() AND subscription = 'admin'
      )
    )
  );

-- Users can update their own messages (within time limit)
CREATE POLICY "Users can update their own messages" ON public.support_messages
  FOR UPDATE USING (
    auth.uid() = user_id AND 
    created_at > (now() - interval '15 minutes')
  );

-- Admins can update any message
CREATE POLICY "Admins can update any message" ON public.support_messages
  FOR UPDATE USING (
    EXISTS (
      SELECT 1 FROM public.profiles 
      WHERE id = auth.uid() AND subscription = 'admin'
    )
  );

-- Create RLS policies for support_attachments
-- Users can view attachments for messages they can see
CREATE POLICY "Users can view attachments for accessible messages" ON public.support_attachments
  FOR SELECT USING (
    EXISTS (
      SELECT 1 FROM public.support_messages sm
      JOIN public.support_tickets st ON sm.ticket_id = st.id
      WHERE sm.id = message_id AND (
        st.user_id = auth.uid() OR 
        EXISTS (
          SELECT 1 FROM public.profiles 
          WHERE id = auth.uid() AND subscription = 'admin'
        )
      )
    )
  );

-- Users can create attachments for their own messages
CREATE POLICY "Users can create attachments for their messages" ON public.support_attachments
  FOR INSERT WITH CHECK (
    EXISTS (
      SELECT 1 FROM public.support_messages sm
      JOIN public.support_tickets st ON sm.ticket_id = st.id
      WHERE sm.id = message_id AND sm.user_id = auth.uid() AND (
        st.user_id = auth.uid() OR 
        EXISTS (
          SELECT 1 FROM public.profiles 
          WHERE id = auth.uid() AND subscription = 'admin'
        )
      )
    )
  );

-- Create function to generate ticket numbers
CREATE OR REPLACE FUNCTION generate_ticket_number()
RETURNS text AS $$
DECLARE
  next_number integer;
  ticket_number text;
BEGIN
  -- Get the next ticket number by counting existing tickets
  SELECT COALESCE(MAX(CAST(SUBSTRING(ticket_number FROM 3) AS integer)), 0) + 1
  INTO next_number
  FROM public.support_tickets
  WHERE ticket_number ~ '^T-[0-9]+$';
  
  -- Format as T-XXX with zero padding
  ticket_number := 'T-' || LPAD(next_number::text, 3, '0');
  
  RETURN ticket_number;
END;
$$ LANGUAGE plpgsql;

-- Create trigger to auto-generate ticket numbers
CREATE OR REPLACE FUNCTION set_ticket_number()
RETURNS trigger AS $$
BEGIN
  IF NEW.ticket_number IS NULL OR NEW.ticket_number = '' THEN
    NEW.ticket_number := generate_ticket_number();
  END IF;
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_set_ticket_number
  BEFORE INSERT ON public.support_tickets
  FOR EACH ROW
  EXECUTE FUNCTION set_ticket_number();

-- Create updated_at triggers
CREATE TRIGGER handle_updated_at_support_tickets 
  BEFORE UPDATE ON public.support_tickets
  FOR EACH ROW 
  EXECUTE PROCEDURE moddatetime(updated_at);

CREATE TRIGGER handle_updated_at_support_messages 
  BEFORE UPDATE ON public.support_messages
  FOR EACH ROW 
  EXECUTE PROCEDURE moddatetime(updated_at);

-- Create function to update ticket timestamp when messages are added
CREATE OR REPLACE FUNCTION update_ticket_on_message()
RETURNS trigger AS $$
BEGIN
  -- Update the ticket's updated_at timestamp
  UPDATE public.support_tickets 
  SET updated_at = now()
  WHERE id = NEW.ticket_id;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_ticket_on_message
  AFTER INSERT ON public.support_messages
  FOR EACH ROW
  EXECUTE FUNCTION update_ticket_on_message();

-- Create function to auto-set resolved_at and closed_at timestamps
CREATE OR REPLACE FUNCTION update_ticket_status_timestamps()
RETURNS trigger AS $$
BEGIN
  -- Set resolved_at when status changes to resolved
  IF NEW.status = 'resolved' AND OLD.status != 'resolved' THEN
    NEW.resolved_at := now();
  END IF;
  
  -- Set closed_at when status changes to closed
  IF NEW.status = 'closed' AND OLD.status != 'closed' THEN
    NEW.closed_at := now();
  END IF;
  
  -- Clear timestamps if status changes back
  IF NEW.status != 'resolved' AND OLD.status = 'resolved' THEN
    NEW.resolved_at := NULL;
  END IF;
  
  IF NEW.status != 'closed' AND OLD.status = 'closed' THEN
    NEW.closed_at := NULL;
  END IF;
  
  RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_ticket_status_timestamps
  BEFORE UPDATE ON public.support_tickets
  FOR EACH ROW
  EXECUTE FUNCTION update_ticket_status_timestamps(); 


-- ============================================================================
-- Migration: 20241221000000_create_email_campaigns_system.sql
-- ============================================================================

-- Email Campaigns System Migration
-- Created: 2024-12-21
-- Description: Complete email campaigns system with subscriber management, templates, campaigns, analytics, and automation

-- Enable necessary extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- =============================================
-- MIGRATION SAFETY CHECKS
-- =============================================

-- Check if this migration has already been run
DO $$
BEGIN
  IF EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'subscribers' AND table_schema = 'public') THEN
    RAISE NOTICE 'Email campaigns system already exists. Skipping table creation but updating functions/views...';
  ELSE
    RAISE NOTICE 'Creating new email campaigns system...';
  END IF;
END $$;

-- =============================================
-- CUSTOM TYPES FOR BETTER PERFORMANCE & CONSISTENCY
-- =============================================

-- Create ENUM types for better performance and data consistency
DO $$ 
BEGIN
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'subscriber_status') THEN
    CREATE TYPE subscriber_status AS ENUM ('active', 'unsubscribed', 'bounced', 'pending');
  END IF;
  
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'campaign_status') THEN
    CREATE TYPE campaign_status AS ENUM ('draft', 'scheduled', 'sending', 'sent', 'paused', 'failed');
  END IF;
  
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'template_status') THEN
    CREATE TYPE template_status AS ENUM ('draft', 'active', 'archived');
  END IF;
  
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'template_type') THEN
    CREATE TYPE template_type AS ENUM ('welcome', 'newsletter', 'promotional', 'transactional', 'custom');
  END IF;
  
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'automation_trigger') THEN
    CREATE TYPE automation_trigger AS ENUM ('signup', 'purchase', 'abandonment', 'anniversary', 'behavior', 'custom');
  END IF;
  
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'email_send_status') THEN
    CREATE TYPE email_send_status AS ENUM ('pending', 'sent', 'delivered', 'bounced', 'failed');
  END IF;
  
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'bounce_type') THEN
    CREATE TYPE bounce_type AS ENUM ('hard', 'soft', 'complaint');
  END IF;
  
  IF NOT EXISTS (SELECT 1 FROM pg_type WHERE typname = 'notification_severity') THEN
    CREATE TYPE notification_severity AS ENUM ('info', 'warning', 'error', 'critical');
  END IF;
END $$;

-- =============================================
-- 1. SUBSCRIBER MANAGEMENT
-- =============================================

-- Main subscribers table (cleaned up - removed calculated fields)
CREATE TABLE IF NOT EXISTS subscribers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  email VARCHAR(255) UNIQUE NOT NULL CHECK (email ~* '^[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,}$'),
  status subscriber_status DEFAULT 'active',
  subscribe_date TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  unsubscribe_date TIMESTAMP WITH TIME ZONE,
  CONSTRAINT valid_unsubscribe_date CHECK (unsubscribe_date IS NULL OR unsubscribe_date >= subscribe_date),
  CONSTRAINT valid_status_dates CHECK (
    (status = 'unsubscribed' AND unsubscribe_date IS NOT NULL) OR 
    (status != 'unsubscribed' AND unsubscribe_date IS NULL)
  ),
  source VARCHAR(100), -- 'website', 'import', 'api', etc.
  metadata JSONB DEFAULT '{}',
  tags TEXT[] DEFAULT '{}',
  preferences JSONB DEFAULT '{}',
  -- Note: first_name, last_name come from auth.users profile
  -- Note: engagement_level, total_opens, total_clicks calculated via views
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Subscriber imports tracking
CREATE TABLE IF NOT EXISTS subscriber_imports (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  filename VARCHAR(255) NOT NULL,
  total_rows INTEGER NOT NULL,
  successful_imports INTEGER DEFAULT 0,
  failed_imports INTEGER DEFAULT 0,
  import_status VARCHAR(50) DEFAULT 'processing' CHECK (import_status IN ('processing', 'completed', 'failed')),
  error_log TEXT,
  imported_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Subscriber tags for organization
CREATE TABLE IF NOT EXISTS subscriber_tags (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(100) UNIQUE NOT NULL,
  description TEXT,
  color VARCHAR(7) DEFAULT '#007bff', -- Hex color code
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =============================================
-- 2. TEMPLATE SYSTEM
-- =============================================

-- Email templates
CREATE TABLE IF NOT EXISTS email_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  description TEXT,
  subject VARCHAR(500),
  html_content TEXT,
  text_content TEXT,
  template_type template_type DEFAULT 'custom',
  status template_status DEFAULT 'draft',
  variables JSONB DEFAULT '{}', -- Template variables like {{firstName}}
  created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  last_used_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Template versions for version control
CREATE TABLE IF NOT EXISTS email_template_versions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  template_id UUID REFERENCES email_templates(id) ON DELETE CASCADE,
  version_number INTEGER NOT NULL,
  name VARCHAR(255) NOT NULL,
  html_content TEXT,
  text_content TEXT,
  variables JSONB DEFAULT '{}',
  created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(template_id, version_number)
);

-- Template favorites
CREATE TABLE IF NOT EXISTS email_template_favorites (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  template_id UUID REFERENCES email_templates(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(template_id, user_id)
);

-- Template ratings and reviews
CREATE TABLE IF NOT EXISTS email_template_ratings (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  template_id UUID REFERENCES email_templates(id) ON DELETE CASCADE,
  user_id UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  rating INTEGER CHECK (rating BETWEEN 1 AND 5),
  review TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(template_id, user_id)
);

-- Transactional email templates
CREATE TABLE IF NOT EXISTS transactional_email_templates (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  template_key VARCHAR(100) UNIQUE NOT NULL, -- 'order_confirmation', 'password_reset', etc.
  template_id UUID REFERENCES email_templates(id) ON DELETE SET NULL,
  is_active BOOLEAN DEFAULT true,
  fallback_template_id UUID REFERENCES email_templates(id) ON DELETE SET NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Template cloning history
CREATE TABLE IF NOT EXISTS email_template_clones (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  original_template_id UUID REFERENCES email_templates(id) ON DELETE CASCADE,
  cloned_template_id UUID REFERENCES email_templates(id) ON DELETE CASCADE,
  cloned_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  clone_type VARCHAR(50) DEFAULT 'duplicate' CHECK (clone_type IN ('duplicate', 'fork', 'branch')),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Email element types for visual editor
CREATE TABLE IF NOT EXISTS email_element_types (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  type_name VARCHAR(100) UNIQUE NOT NULL, -- 'header', 'text', 'button', 'image', 'divider', 'spacer'
  display_name VARCHAR(200) NOT NULL,
  description TEXT,
  default_properties JSONB DEFAULT '{}',
  is_active BOOLEAN DEFAULT true,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =============================================
-- 3. AUDIENCE MANAGEMENT
-- =============================================

-- Audience segments
CREATE TABLE IF NOT EXISTS email_audiences (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  description TEXT,
  query_conditions JSONB NOT NULL, -- Dynamic query conditions
  is_dynamic BOOLEAN DEFAULT true,
  created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Junction table for audience-subscriber relationships
CREATE TABLE IF NOT EXISTS email_audience_subscribers (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  audience_id UUID REFERENCES email_audiences(id) ON DELETE CASCADE,
  subscriber_id UUID REFERENCES subscribers(id) ON DELETE CASCADE,
  added_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  UNIQUE(audience_id, subscriber_id)
);

-- =============================================
-- 4. CAMPAIGN MANAGEMENT
-- =============================================

-- Email campaigns
CREATE TABLE IF NOT EXISTS email_campaigns (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  subject VARCHAR(500) NOT NULL,
  sender_name VARCHAR(255) DEFAULT 'Cymasphere',
  sender_email VARCHAR(255) DEFAULT 'support@cymasphere.com',
  reply_to_email VARCHAR(255),
  preheader TEXT,
  html_content TEXT,
  text_content TEXT,
  template_id UUID REFERENCES email_templates(id) ON DELETE SET NULL,
  audience_id UUID REFERENCES email_audiences(id) ON DELETE SET NULL,
  status campaign_status DEFAULT 'draft',
  scheduled_at TIMESTAMP WITH TIME ZONE,
  sent_at TIMESTAMP WITH TIME ZONE,
  CONSTRAINT valid_campaign_dates CHECK (
    (status = 'scheduled' AND scheduled_at IS NOT NULL) OR
    (status != 'scheduled') OR
    (scheduled_at IS NULL)
  ),
  CONSTRAINT valid_sent_date CHECK (sent_at IS NULL OR sent_at >= created_at),
  created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Campaign scheduling queue
CREATE TABLE IF NOT EXISTS email_campaign_schedule_queue (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  campaign_id UUID REFERENCES email_campaigns(id) ON DELETE CASCADE,
  scheduled_for TIMESTAMP WITH TIME ZONE NOT NULL,
  status VARCHAR(50) DEFAULT 'pending' CHECK (status IN ('pending', 'processing', 'completed', 'failed')),
  retry_count INTEGER DEFAULT 0,
  error_message TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  processed_at TIMESTAMP WITH TIME ZONE
);

-- Campaign preview and testing
CREATE TABLE IF NOT EXISTS email_campaign_previews (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  campaign_id UUID REFERENCES email_campaigns(id) ON DELETE CASCADE,
  preview_type VARCHAR(50) DEFAULT 'browser' CHECK (preview_type IN ('browser', 'email', 'device')),
  device_type VARCHAR(50) CHECK (device_type IN ('desktop', 'mobile', 'tablet')),
  email_client VARCHAR(100), -- 'gmail', 'outlook', 'apple_mail', etc.
  preview_url TEXT,
  generated_html TEXT,
  generated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  expires_at TIMESTAMP WITH TIME ZONE DEFAULT (NOW() + INTERVAL '24 hours')
);

-- Test email sends
CREATE TABLE IF NOT EXISTS email_test_sends (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  campaign_id UUID REFERENCES email_campaigns(id) ON DELETE CASCADE,
  template_id UUID REFERENCES email_templates(id) ON DELETE CASCADE,
  test_email VARCHAR(255) NOT NULL,
  sent_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  status email_send_status DEFAULT 'pending',
  error_message TEXT,
  sent_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =============================================
-- 5. EMAIL TRACKING
-- =============================================

-- Individual email sends
CREATE TABLE IF NOT EXISTS email_sends (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  campaign_id UUID REFERENCES email_campaigns(id) ON DELETE CASCADE,
  subscriber_id UUID REFERENCES subscribers(id) ON DELETE CASCADE,
  email_address VARCHAR(255) NOT NULL,
  status email_send_status DEFAULT 'pending',
  sent_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  delivered_at TIMESTAMP WITH TIME ZONE,
  message_id VARCHAR(255), -- Provider message ID
  error_message TEXT
);

-- Email opens tracking (partitioned by month for performance)
CREATE TABLE IF NOT EXISTS email_opens (
  id UUID DEFAULT gen_random_uuid(),
  send_id UUID REFERENCES email_sends(id) ON DELETE CASCADE,
  subscriber_id UUID REFERENCES subscribers(id) ON DELETE CASCADE,
  campaign_id UUID REFERENCES email_campaigns(id) ON DELETE CASCADE,
  ip_address INET,
  user_agent TEXT,
  opened_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  PRIMARY KEY (id, opened_at)
) PARTITION BY RANGE (opened_at);

-- Create partitions for current and next 3 months (can be extended)
CREATE TABLE IF NOT EXISTS email_opens_2024_12 PARTITION OF email_opens
  FOR VALUES FROM ('2024-12-01') TO ('2025-01-01');
CREATE TABLE IF NOT EXISTS email_opens_2025_01 PARTITION OF email_opens
  FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
CREATE TABLE IF NOT EXISTS email_opens_2025_02 PARTITION OF email_opens
  FOR VALUES FROM ('2025-02-01') TO ('2025-03-01');
CREATE TABLE IF NOT EXISTS email_opens_default PARTITION OF email_opens DEFAULT;

-- Email clicks tracking (partitioned by month for performance)
CREATE TABLE IF NOT EXISTS email_clicks (
  id UUID DEFAULT gen_random_uuid(),
  send_id UUID REFERENCES email_sends(id) ON DELETE CASCADE,
  subscriber_id UUID REFERENCES subscribers(id) ON DELETE CASCADE,
  campaign_id UUID REFERENCES email_campaigns(id) ON DELETE CASCADE,
  url TEXT NOT NULL,
  ip_address INET,
  user_agent TEXT,
  clicked_at TIMESTAMP WITH TIME ZONE DEFAULT NOW() NOT NULL,
  PRIMARY KEY (id, clicked_at)
) PARTITION BY RANGE (clicked_at);

-- Create partitions for current and next 3 months
CREATE TABLE IF NOT EXISTS email_clicks_2024_12 PARTITION OF email_clicks
  FOR VALUES FROM ('2024-12-01') TO ('2025-01-01');
CREATE TABLE IF NOT EXISTS email_clicks_2025_01 PARTITION OF email_clicks
  FOR VALUES FROM ('2025-01-01') TO ('2025-02-01');
CREATE TABLE IF NOT EXISTS email_clicks_2025_02 PARTITION OF email_clicks
  FOR VALUES FROM ('2025-02-01') TO ('2025-03-01');
CREATE TABLE IF NOT EXISTS email_clicks_default PARTITION OF email_clicks DEFAULT;

-- Email unsubscribes
CREATE TABLE IF NOT EXISTS email_unsubscribes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  send_id UUID REFERENCES email_sends(id) ON DELETE SET NULL,
  subscriber_id UUID REFERENCES subscribers(id) ON DELETE CASCADE,
  campaign_id UUID REFERENCES email_campaigns(id) ON DELETE SET NULL,
  reason VARCHAR(255),
  unsubscribed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Email bounces
CREATE TABLE IF NOT EXISTS email_bounces (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  send_id UUID REFERENCES email_sends(id) ON DELETE CASCADE,
  subscriber_id UUID REFERENCES subscribers(id) ON DELETE CASCADE,
  campaign_id UUID REFERENCES email_campaigns(id) ON DELETE CASCADE,
  bounce_type bounce_type NOT NULL,
  bounce_subtype VARCHAR(100),
  bounce_reason TEXT,
  diagnostic_code TEXT,
  bounced_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =============================================
-- 6. AUTOMATION SYSTEM
-- =============================================

-- Email automations
CREATE TABLE IF NOT EXISTS email_automations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  description TEXT,
  trigger_type VARCHAR(100) NOT NULL CHECK (trigger_type IN ('signup', 'purchase', 'abandonment', 'anniversary', 'behavior', 'custom')),
  trigger_conditions JSONB DEFAULT '{}',
  email_sequence JSONB NOT NULL, -- Array of emails with delays
  status VARCHAR(50) DEFAULT 'draft' CHECK (status IN ('draft', 'active', 'paused', 'archived')),
  created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Automation enrollments
CREATE TABLE IF NOT EXISTS email_automation_enrollments (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  automation_id UUID REFERENCES email_automations(id) ON DELETE CASCADE,
  subscriber_id UUID REFERENCES subscribers(id) ON DELETE CASCADE,
  current_step INTEGER DEFAULT 0,
  status VARCHAR(50) DEFAULT 'active' CHECK (status IN ('active', 'completed', 'paused', 'cancelled')),
  enrolled_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  completed_at TIMESTAMP WITH TIME ZONE,
  next_send_at TIMESTAMP WITH TIME ZONE
);

-- =============================================
-- 7. A/B TESTING
-- =============================================

-- A/B tests
CREATE TABLE IF NOT EXISTS email_ab_tests (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  campaign_id UUID REFERENCES email_campaigns(id) ON DELETE CASCADE,
  test_name VARCHAR(255) NOT NULL,
  test_type VARCHAR(100) NOT NULL CHECK (test_type IN ('subject_line', 'sender_name', 'content', 'send_time')),
  variants JSONB NOT NULL, -- Array of test variants
  traffic_split JSONB DEFAULT '{"A": 50, "B": 50}', -- Percentage split
  winner_criteria VARCHAR(100) DEFAULT 'open_rate' CHECK (winner_criteria IN ('open_rate', 'click_rate', 'conversion_rate')),
  status VARCHAR(50) DEFAULT 'draft' CHECK (status IN ('draft', 'running', 'completed', 'paused')),
  started_at TIMESTAMP WITH TIME ZONE,
  completed_at TIMESTAMP WITH TIME ZONE,
  winner_variant VARCHAR(10),
  created_by UUID REFERENCES auth.users(id) ON DELETE SET NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- A/B test results (calculated fields removed - use views for these)
CREATE TABLE IF NOT EXISTS email_ab_test_results (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  ab_test_id UUID REFERENCES email_ab_tests(id) ON DELETE CASCADE,
  variant VARCHAR(10) NOT NULL,
  statistical_significance DECIMAL(5,2) DEFAULT 0,
  is_winner BOOLEAN DEFAULT false,
  calculated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- =============================================
-- 8. ANALYTICS & REPORTING
-- =============================================

-- Campaign analytics
CREATE TABLE IF NOT EXISTS email_campaign_analytics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  campaign_id UUID REFERENCES email_campaigns(id) ON DELETE CASCADE,
  subscriber_id UUID REFERENCES subscribers(id) ON DELETE CASCADE,
  event_type VARCHAR(50) NOT NULL CHECK (event_type IN ('sent', 'delivered', 'opened', 'clicked', 'bounced', 'unsubscribed', 'spam')),
  device_type VARCHAR(50),
  browser VARCHAR(100),
  operating_system VARCHAR(100),
  country VARCHAR(100),
  region VARCHAR(100),
  city VARCHAR(100),
  utm_source VARCHAR(255),
  utm_medium VARCHAR(255),
  utm_campaign VARCHAR(255),
  revenue DECIMAL(10,2),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Domain reputation tracking
CREATE TABLE IF NOT EXISTS email_domain_reputation (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  domain VARCHAR(255) UNIQUE NOT NULL,
  reputation_score INTEGER DEFAULT 100 CHECK (reputation_score BETWEEN 0 AND 100),
  dkim_status VARCHAR(50) DEFAULT 'not_configured' CHECK (dkim_status IN ('valid', 'invalid', 'not_configured')),
  spf_status VARCHAR(50) DEFAULT 'not_configured' CHECK (spf_status IN ('pass', 'fail', 'not_configured')),
  dmarc_status VARCHAR(50) DEFAULT 'not_configured' CHECK (dmarc_status IN ('pass', 'fail', 'not_configured')),
  is_blacklisted BOOLEAN DEFAULT false,
  blacklist_sources TEXT[],
  last_checked_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Campaign results summary (REMOVED - these are all calculated fields)
-- Use views or calculate on-demand from email_sends, email_opens, email_clicks, etc.

-- System notifications
CREATE TABLE IF NOT EXISTS email_system_notifications (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  notification_type VARCHAR(100) NOT NULL CHECK (notification_type IN ('deliverability_warning', 'bounce_threshold', 'api_limit', 'domain_reputation', 'campaign_completed', 'automation_error')),
  severity notification_severity DEFAULT 'info',
  title VARCHAR(255) NOT NULL,
  message TEXT NOT NULL,
  metadata JSONB DEFAULT '{}',
  is_read BOOLEAN DEFAULT false,
  created_for UUID REFERENCES auth.users(id) ON DELETE CASCADE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  read_at TIMESTAMP WITH TIME ZONE
);

-- =============================================
-- INDEXES FOR PERFORMANCE
-- =============================================

-- Subscribers indexes
CREATE INDEX IF NOT EXISTS idx_subscribers_email ON subscribers(email);
CREATE INDEX IF NOT EXISTS idx_subscribers_status ON subscribers(status);
CREATE INDEX IF NOT EXISTS idx_subscribers_user_id ON subscribers(user_id);
-- Note: engagement_level removed from table, calculated in views
CREATE INDEX IF NOT EXISTS idx_subscribers_tags ON subscribers USING GIN(tags);

-- Templates indexes
CREATE INDEX IF NOT EXISTS idx_templates_type ON email_templates(template_type);
CREATE INDEX IF NOT EXISTS idx_templates_status ON email_templates(status);
CREATE INDEX IF NOT EXISTS idx_templates_created_by ON email_templates(created_by);

-- Campaigns indexes
CREATE INDEX IF NOT EXISTS idx_campaigns_status ON email_campaigns(status);
CREATE INDEX IF NOT EXISTS idx_campaigns_created_by ON email_campaigns(created_by);
CREATE INDEX IF NOT EXISTS idx_campaigns_scheduled_at ON email_campaigns(scheduled_at);
CREATE INDEX IF NOT EXISTS idx_campaigns_template_id ON email_campaigns(template_id);
CREATE INDEX IF NOT EXISTS idx_campaigns_audience_id ON email_campaigns(audience_id);

-- Tracking indexes
CREATE INDEX IF NOT EXISTS idx_sends_campaign_id ON email_sends(campaign_id);
CREATE INDEX IF NOT EXISTS idx_sends_subscriber_id ON email_sends(subscriber_id);
CREATE INDEX IF NOT EXISTS idx_sends_status ON email_sends(status);
CREATE INDEX IF NOT EXISTS idx_opens_send_id ON email_opens(send_id);
CREATE INDEX IF NOT EXISTS idx_opens_subscriber_id ON email_opens(subscriber_id);
CREATE INDEX IF NOT EXISTS idx_clicks_send_id ON email_clicks(send_id);
CREATE INDEX IF NOT EXISTS idx_clicks_subscriber_id ON email_clicks(subscriber_id);
CREATE INDEX IF NOT EXISTS idx_bounces_send_id ON email_bounces(send_id);
CREATE INDEX IF NOT EXISTS idx_bounces_subscriber_id ON email_bounces(subscriber_id);
CREATE INDEX IF NOT EXISTS idx_bounces_bounce_type ON email_bounces(bounce_type);

-- Analytics indexes
CREATE INDEX IF NOT EXISTS idx_analytics_campaign_id ON email_campaign_analytics(campaign_id);
CREATE INDEX IF NOT EXISTS idx_analytics_event_type ON email_campaign_analytics(event_type);
CREATE INDEX IF NOT EXISTS idx_analytics_created_at ON email_campaign_analytics(created_at);

-- Automation indexes
CREATE INDEX IF NOT EXISTS idx_automations_status ON email_automations(status);
CREATE INDEX IF NOT EXISTS idx_automations_trigger_type ON email_automations(trigger_type);
CREATE INDEX IF NOT EXISTS idx_enrollments_automation_id ON email_automation_enrollments(automation_id);
CREATE INDEX IF NOT EXISTS idx_enrollments_subscriber_id ON email_automation_enrollments(subscriber_id);
CREATE INDEX IF NOT EXISTS idx_enrollments_status ON email_automation_enrollments(status);

-- A/B test indexes
CREATE INDEX IF NOT EXISTS idx_ab_tests_campaign_id ON email_ab_tests(campaign_id);
CREATE INDEX IF NOT EXISTS idx_ab_tests_status ON email_ab_tests(status);

-- Additional specialized indexes
CREATE INDEX IF NOT EXISTS idx_transactional_templates_key ON transactional_email_templates(template_key);
CREATE INDEX IF NOT EXISTS idx_transactional_templates_active ON transactional_email_templates(is_active);
CREATE INDEX IF NOT EXISTS idx_template_clones_original ON email_template_clones(original_template_id);
CREATE INDEX IF NOT EXISTS idx_template_clones_cloned ON email_template_clones(cloned_template_id);
CREATE INDEX IF NOT EXISTS idx_campaign_previews_campaign ON email_campaign_previews(campaign_id);
CREATE INDEX IF NOT EXISTS idx_test_sends_campaign ON email_test_sends(campaign_id);
CREATE INDEX IF NOT EXISTS idx_test_sends_status ON email_test_sends(status);
CREATE INDEX IF NOT EXISTS idx_system_notifications_type ON email_system_notifications(notification_type);
CREATE INDEX IF NOT EXISTS idx_system_notifications_severity ON email_system_notifications(severity);
CREATE INDEX IF NOT EXISTS idx_system_notifications_user_unread ON email_system_notifications(created_for, is_read) WHERE is_read = false;

-- Additional performance indexes for Supabase integration
CREATE INDEX IF NOT EXISTS idx_subscribers_user_status ON subscribers(user_id, status) WHERE status = 'active';
CREATE INDEX IF NOT EXISTS idx_email_opens_subscriber_date ON email_opens(subscriber_id, opened_at);
CREATE INDEX IF NOT EXISTS idx_email_clicks_subscriber_date ON email_clicks(subscriber_id, clicked_at);
CREATE INDEX IF NOT EXISTS idx_profiles_subscription_active ON profiles(subscription) WHERE subscription != 'none';
CREATE INDEX IF NOT EXISTS idx_profiles_trial_active ON profiles(trial_expiration);

-- Advanced composite indexes for common query patterns
CREATE INDEX IF NOT EXISTS idx_campaigns_status_created_at ON email_campaigns(status, created_at DESC) WHERE status IN ('draft', 'scheduled');
CREATE INDEX IF NOT EXISTS idx_sends_campaign_status_sent ON email_sends(campaign_id, status, sent_at DESC) WHERE status IN ('sent', 'delivered');
CREATE INDEX IF NOT EXISTS idx_subscriber_engagement_composite ON subscribers(status, subscribe_date DESC) WHERE status = 'active';

-- Functional indexes for common search patterns
CREATE INDEX IF NOT EXISTS idx_subscribers_email_domain ON subscribers(email) WHERE status = 'active';
CREATE INDEX IF NOT EXISTS idx_campaigns_sent_date ON email_campaigns(sent_at) WHERE sent_at IS NOT NULL;

-- JSONB indexes for metadata and preferences
CREATE INDEX IF NOT EXISTS idx_subscribers_preferences ON subscribers USING GIN(preferences) WHERE preferences IS NOT NULL;
CREATE INDEX IF NOT EXISTS idx_templates_variables ON email_templates USING GIN(variables) WHERE variables IS NOT NULL;

-- Full-text search indexes
CREATE INDEX IF NOT EXISTS idx_campaigns_fulltext ON email_campaigns USING GIN(to_tsvector('english', COALESCE(name, '') || ' ' || COALESCE(subject, '')));
CREATE INDEX IF NOT EXISTS idx_templates_fulltext ON email_templates USING GIN(to_tsvector('english', COALESCE(name, '') || ' ' || COALESCE(description, '')));

-- =============================================
-- INSERT DEFAULT DATA
-- =============================================

-- Insert default email element types
INSERT INTO email_element_types (type_name, display_name, description, default_properties, sort_order) 
VALUES
  ('header', 'Header', 'Main heading text', '{"fontSize": "24px", "color": "#333", "textAlign": "center"}', 1),
  ('text', 'Text Block', 'Paragraph text content', '{"fontSize": "16px", "color": "#666", "lineHeight": "1.5"}', 2),
  ('button', 'Call-to-Action Button', 'Clickable button with link', '{"backgroundColor": "#007bff", "color": "#fff", "padding": "12px 24px"}', 3),
  ('image', 'Image', 'Embedded image', '{"width": "100%", "height": "auto"}', 4),
  ('divider', 'Divider Line', 'Horizontal separator', '{"height": "1px", "backgroundColor": "#eee"}', 5),
  ('spacer', 'Spacer', 'Empty spacing element', '{"height": "20px"}', 6)
ON CONFLICT (type_name) DO NOTHING;

-- Insert default transactional email template mappings
INSERT INTO transactional_email_templates (template_key, is_active) 
VALUES
  ('order_confirmation', true),
  ('password_reset', true),
  ('welcome_email', true),
  ('account_verification', true),
  ('payment_receipt', true),
  ('subscription_renewal', true)
ON CONFLICT (template_key) DO NOTHING;

-- Insert default subscriber tags (including subscription-based tags)
INSERT INTO subscriber_tags (name, description, color) 
VALUES
  ('VIP', 'VIP customers and high-value subscribers', '#ff6b6b'),
  ('New User', 'Recently signed up users', '#4ecdc4'),
  ('Producer', 'Music producers and creators', '#45b7d1'),
  ('DJ', 'DJs and performers', '#96ceb4'),
  ('Student', 'Students and learners', '#ffeaa7'),
  ('Professional', 'Professional musicians', '#dda0dd'),
  ('Beginner', 'Beginner users', '#98d8c8'),
  ('Free User', 'Users with no subscription', '#95a5a6'),
  ('Monthly Subscriber', 'Monthly subscription users', '#3498db'),
